<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Owner Panel | Jamison Protection</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #121212;
            color: #f0f0f0;
            margin: 0;
            padding: 0;
        }
        header {
            background: #1c1c1c;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #444;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        main {
            max-width: 900px;
            margin: auto;
            padding: 30px;
        }
        form {
            margin-bottom: 30px;
            background: #1f1f1f;
            padding: 20px;
            border-left: 5px solid #e63946;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        input, textarea {
            background: #2a2a2a;
            color: white;
            border: none;
            padding: 10px;
            margin: 8px 0;
            width: 100%;
        }
        button {
            background: #e63946;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .shift {
            background: #1f1f1f;
            margin: 15px 0;
            padding: 15px;
            border-left: 5px solid #1c1c1c;
        }
    </style>
</head>
<body>
<header>
    <h1>Owner Panel</h1>
    <button class="logout-btn" onclick="logout()">Logout</button>
    <button onclick="switchToWorker()">Switch to Worker View</button>
    <button onclick="goToAdmin()">Open Admin Panel</button>
    <button onclick="loadLogs()">View Submitted Hours</button>
</header>

<main>
    <h2>Post New Shift</h2>
    <form id="postShiftForm">
        <input type="date" id="date" required>
        <input type="time" id="time" required>
        <input type="text" id="location" placeholder="Location" required>
        <textarea id="notes" placeholder="Notes (optional)"></textarea>
        <button type="submit">Post Shift</button>
    </form>

    <h2>All Shifts</h2>
    <div id="shiftList"></div>
    <div id="logContainer" style="margin-top: 30px;"></div>
</main>

<script>
    async function verifySession(retries = 3) {
        try {
            const res = await fetch('/api/session-debug', { credentials: 'include' });
            const data = await res.json();

            if (data.user) {
                console.log('✅ Session OK:', data);
                document.body.insertAdjacentHTML('afterbegin', `<p style="text-align:center;">Welcome, ${data.user}</p>`);
                loadShifts();
                return;
            }

            if (retries > 0) {
                console.log('⏳ Session not ready, retrying...');
                setTimeout(() => verifySession(retries - 1), 500);
            } else {
                console.warn('⚠️ No valid session, redirecting.');
                location.href = 'login.html';
            }
        } catch (err) {
            console.error('Session check failed:', err);
            location.href = 'login.html';
        }
    }

    async function loadShifts() {
        const res = await fetch('/api/view-all-shifts', { credentials: 'include' });
        if (res.status === 401) return (location.href = 'login.html');
        const shifts = await res.json();
        const container = document.getElementById('shiftList');
        container.innerHTML = shifts.length
            ? shifts.map(s => `
            <div class="shift">
              <strong>${s.date} at ${s.time}</strong><br>
              Location: ${s.location}<br>
              Notes: ${s.notes || 'None'}<br>
              Claimed by: ${s.claimedBy || 'Not claimed yet'}
            </div>`).join('')
            : '<p>No shifts found.</p>';
    }

    async function logout() {
        await fetch('/logout', { method: 'POST', credentials: 'include' });
        location.href = 'login.html';
    }

    function switchToWorker() {
        fetch('/api/switch-to-worker', {
            method: 'POST',
            credentials: 'include',
        })
            .then(res => res.ok ? (location.href = 'worker-dashboard.html') : alert('Only the owner can switch.'))
            .catch(err => alert('Switch failed: ' + err.message));
    }

    function goToAdmin() {
        fetch('/api/verify-owner', { credentials: 'include' })
            .then(res => res.ok ? (location.href = 'admin-panel.html') : alert('Access denied.'));
    }

    document.getElementById('postShiftForm').addEventListener('submit', async e => {
        e.preventDefault();
        const date = dateInput.value, time = timeInput.value,
            location = locationInput.value, notes = notesInput.value;

        const res = await fetch('/api/shifts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ date, time, location, notes })
        });

        const data = await res.json();
        alert(data.message);
        loadShifts();
        e.target.reset();
    });

    async function loadLogs() {
        const res = await fetch('/api/view-logs', { credentials: 'include' });
        const logs = await res.json();
        const container = document.getElementById('logContainer');
        container.innerHTML = logs.length
            ? `<h3>Submitted Hours</h3>
           <table border="1" cellpadding="8" cellspacing="0" style="width:100%;margin-top:10px;">
           <tr><th>Username</th><th>Date</th><th>Hours</th><th>Description</th></tr>
           ${logs.map(l => `<tr><td>${l.username}</td><td>${l.date}</td><td>${l.hours}</td><td>${l.description || ''}</td></tr>`).join('')}
           </table>`
            : '<p>No logs available.</p>';
    }

    verifySession();
</script>
</body>
</html>
