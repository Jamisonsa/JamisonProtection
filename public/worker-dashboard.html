<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Worker Dashboard | Jamison Protection</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #121212;
            color: #f0f0f0;
            margin: 0;
            padding: 0;
        }
        header {
            background: #1c1c1c;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #444;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        form {
            background: #1f1f1f;
            padding: 20px;
            margin-top: 40px;
            border-left: 5px solid #e63946;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        input {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            color: white;
            border: none;
            margin: 10px 0;
        }
        button {
            background: #e63946;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .shift {
            background: #1f1f1f;
            margin: 15px 0;
            padding: 15px;
            border-left: 5px solid #e63946;
        }
        #securityLogForm {
            background: #1f1f1f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        #securityLogForm input,
        #securityLogForm select,
        #securityLogForm textarea {
            width: 100%;
            margin: 4px 0;
            padding: 8px;
            border-radius: 4px;
            border: none;
            outline: none;
        }

        #securityLogForm button {
            background: #e63946;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: bold;
        }

        #securityLogForm button:hover {
            background: #c5303d;
        }
        #securityLogFilter input, #securityLogFilter button {
            margin: 5px;
            padding: 8px;
            border-radius: 5px;
            border: none;
        }

        #securityLogFilter button {
            background: #e63946;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        #securityLogFilter button:hover {
            background: #c5303d;
        }
        #logHoursForm {
            background: #1f1f1f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 5px solid #4CAF50;
        }
        #logHoursForm button {
            background: #4CAF50;
        }
        #logHoursForm button:hover {
            background: #3e8e41;
        }

    </style>
</head>
<body>

    <header>
        <h1 id="welcomeMsg">Worker Dashboard</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
        <button onclick="switchToOwner()">Switch to Owner View</button>
    </header>

<main>
    <h2>Available Shifts</h2>
    <div id="shiftList"></div>

    <h2>My Shifts</h2>
    <div id="myShiftList"></div>
    <h2>Log Your Hours</h2>
    <form id="logHoursForm" onsubmit="submitHours(event)">
        <label>Date:</label>
        <input type="date" id="logDate" required><br><br>

        <label>Start Time:</label>
        <input type="time" id="logStart" required><br><br>

        <label>End Time:</label>
        <input type="time" id="logEnd" required><br><br>

        <label>Location:</label>
        <select id="logLocation" required>
            <option value="John Carroll School">John Carroll School</option>
        </select><br><br>

        <label>Work Position:</label>
        <input type="text" id="logPosition" placeholder="e.g. Front Desk" required><br><br>

        <label>Hours Worked:</label>
        <input type="number" id="logHours" step="0.1" placeholder="e.g. 5.5" required><br><br>

        <button type="submit" class="submit-btn">Submit Hours</button>
    </form>

    <hr>

    <h2>Daily Security Log</h2>
    <form id="securityLogForm" onsubmit="submitSecurityLog(event)">
        <label>Date:</label>
        <input type="date" id="logDate" required><br><br>

        <label>Time:</label>
        <input type="time" id="logTime" required><br><br>

        <label>Location:</label>
        <select id="logLocation" required>
            <option value="John Carroll School">John Carroll School</option>
        </select><br><br>

        <label>Description:</label><br>
        <textarea id="logDescription" placeholder="Describe the event or observation..." required></textarea><br><br>

        <label>Worker Initials:</label>
        <input type="text" id="logInitials" maxlength="3" placeholder="e.g. FJ" required><br><br>

        <button type="submit" class="submit-btn">Submit Log</button>
    </form>

    <hr>

    <h3>All Security Logs</h3>

    <div id="securityLogFilter" style="margin-bottom: 15px;">
        <label>Date:</label>
        <input type="date" id="filterDate">

        <label>Worker Initials:</label>
        <input type="text" id="filterInitials" placeholder="e.g. FJ">

        <button onclick="filterSecurityLogs()">Apply Filter</button>
        <button onclick="clearSecurityFilters()">Clear</button>
        <button onclick="exportSecurityLogs()">⬇ Export CSV</button>
    </div>

    <div id="securityLogsContainer">
        <p>Loading logs...</p>
    </div>


</main>

<script>
        async function loadShifts() {
        const res = await fetch('/api/shifts', { credentials: 'include' });
        if (res.status === 401) return (location.href = 'login.html');
        const shifts = await res.json();
        const available = shifts.filter(s => s.status !== 'claimed');

        const container = document.getElementById('shiftList');
        container.innerHTML = available.length
        ? available.map(s => `
                <div class="shift">
                    <strong>${s.date} at ${s.time}</strong><br>
                    Location: ${s.location}<br>
                    Notes: ${s.notes || 'None'}<br>
                    Status: ${s.status}<br>
                    <button onclick="claimShift('${s._id}')">Claim</button>
                </div>
            `).join('')
        : '<p>No available shifts at this time.</p>';
    }

        async function loadMyShifts() {
        const res = await fetch('/api/my-shifts', { credentials: 'include' });
        if (res.status === 401) return (location.href = 'login.html');
        const shifts = await res.json();

        const container = document.getElementById('myShiftList');
        container.innerHTML = shifts.length
        ? shifts.map(s => `
                <div class="shift">
                    <strong>${s.date} at ${s.time}</strong><br>
                    Location: ${s.location}<br>
                    Notes: ${s.notes || 'None'}<br>
                    <button onclick="dropShift('${s._id}')">Drop Shift</button>
                </div>
            `).join('')
        : '<p>You have no claimed shifts.</p>';
    }
        async function submitHours(event) {
            event.preventDefault();

            const log = {
                date: document.getElementById('logDate').value,
                startTime: document.getElementById('logStart').value,
                endTime: document.getElementById('logEnd').value,
                location: document.getElementById('logLocation').value,
                position: document.getElementById('logPosition').value,
                hours: document.getElementById('logHours').value
            };

            const res = await fetch('/api/log-hours', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(log)
            });

            const data = await res.json();
            alert(data.message);
            document.getElementById('logHoursForm').reset();
        }
        async function submitSecurityLog(event) {
            event.preventDefault();

            const log = {
                date: document.getElementById('logDate').value,
                time: document.getElementById('logTime').value,
                location: document.getElementById('logLocation').value,
                description: document.getElementById('logDescription').value,
                initials: document.getElementById('logInitials').value
            };

            const res = await fetch('/api/security-logs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(log)
            });

            const data = await res.json();
            alert(data.message);
            document.getElementById('securityLogForm').reset();
            loadSecurityLogs();
        }

        async function loadSecurityLogs(date = '', initials = '') {
            try {
                let url = '/api/security-logs';
                const params = [];
                if (date) params.push(`date=${encodeURIComponent(date)}`);
                if (initials) params.push(`initials=${encodeURIComponent(initials)}`);
                if (params.length) url += '?' + params.join('&');

                const res = await fetch(url, { credentials: 'include' });
                const logs = await res.json();

                const container = document.getElementById('securityLogsContainer');
                if (!logs.length) {
                    container.innerHTML = '<p>No logs found for selected criteria.</p>';
                    return;
                }

                container.innerHTML = logs.map(log => `
      <div class="shift" style="background:#1f1f1f; margin:8px 0; padding:10px; border-left:4px solid #f2c744;">
        <strong>${log.date} ${log.time}</strong> — <em>${log.location}</em><br>
        ${log.description}<br>
        <small>Initials: ${log.initials} | Submitted by: ${log.submittedBy}</small>
      </div>
    `).join('');
            } catch (err) {
                console.error('Failed to load security logs:', err);
            }
        }


        // Load logs automatically on page load
        document.addEventListener('DOMContentLoaded', loadSecurityLogs);
        function filterSecurityLogs() {
            const date = document.getElementById('filterDate').value;
            const initials = document.getElementById('filterInitials').value;
            loadSecurityLogs(date, initials);
        }

        function clearSecurityFilters() {
            document.getElementById('filterDate').value = '';
            document.getElementById('filterInitials').value = '';
            loadSecurityLogs();
        }

        function exportSecurityLogs() {
            const date = document.getElementById('filterDate').value;
            const initials = document.getElementById('filterInitials').value;

            let url = '/api/security-logs?format=csv';
            if (date) url += `&date=${encodeURIComponent(date)}`;
            if (initials) url += `&initials=${encodeURIComponent(initials)}`;

            window.open(url, '_blank');
        }

        async function claimShift(id) {
        const res = await fetch('/api/claim', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ shiftId: id })
    });
        const data = await res.json();
        alert(data.message);
        await loadShifts();
        await loadMyShifts();
    }

        async function dropShift(shiftId) {
        const res = await fetch('/api/drop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ shiftId })
    });
        const data = await res.json();
        alert(data.message);
        await loadShifts();
        await loadMyShifts();
    }

        async function logout() {
        try {
        const res = await fetch('/logout', {
        method: 'POST',
        credentials: 'include'
    });
        if (res.ok) {
        window.location.href = 'login.html';
    } else {
        alert('Logout failed.');
    }
    } catch (err) {
        alert('Error logging out: ' + err.message);
    }
    }

        async function switchToOwner() {
        try {
        const res = await fetch('/api/switch-to-owner', {
        method: 'POST',
        credentials: 'include'
    });
        if (res.ok) {
        window.location.href = 'owner-panel.html';
    } else {
        const data = await res.json();
        alert(data.message || 'Only owners can switch to owner view.');
    }
    } catch (err) {
        alert('Error switching view: ' + err.message);
    }
    }

        // ✅ Fixed session check — safely loads shifts after login
        fetch('/api/session-debug', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
        if (!data.user) return (location.href = 'login.html');
        console.log('Logged in as:', data.user);
        loadShifts();
        loadMyShifts();
    })
        .catch(err => console.error('Session check failed:', err));

</script>

</body>
</html>
