<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Worker Dashboard | Jamison Protection</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #121212;
            color: #f0f0f0;
            margin: 0;
            padding: 0;
        }
        header {
            background: #1c1c1c;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #444;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        form {
            background: #1f1f1f;
            padding: 20px;
            margin-top: 40px;
            border-left: 5px solid #e63946;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        input {
            width: 100%;
            padding: 10px;
            background: #2a2a2a;
            color: white;
            border: none;
            margin: 10px 0;
        }
        button {
            background: #e63946;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .shift {
            background: #1f1f1f;
            margin: 15px 0;
            padding: 15px;
            border-left: 5px solid #e63946;
        }
    </style>
</head>
<body>

    <header>
        <h1 id="welcomeMsg">Worker Dashboard</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
        <button onclick="switchToOwner()">Switch to Owner View</button>
    </header>

<main>
    <h2>Available Shifts</h2>
    <div id="shiftList"></div>

    <h2>My Shifts</h2>
    <div id="myShiftList"></div>

    <h2>Log Your Hours</h2>
    <form id="logHoursForm" onsubmit="submitHours(event)">
        <label>Date:</label>
        <input type="date" id="logDate" required><br><br>

        <label>Start Time:</label>
        <input type="time" id="logStart" required><br><br>

        <label>End Time:</label>
        <input type="time" id="logEnd" required><br><br>

        <label>Location:</label>
        <select id="logLocation" required>
            <option value="John Carroll School">John Carroll School</option>
        </select><br><br>

        <label>Work Position:</label>
        <input type="text" id="logPosition" placeholder="e.g. Door Monitor" required><br><br>

        <label>Hours Worked:</label>
        <input type="number" id="logHours" placeholder="e.g. 5.5" step="0.1" required><br><br>

        <button type="submit" class="submit-btn">Submit Log</button>
    </form>

</main>

<script>
        async function loadShifts() {
        const res = await fetch('/api/shifts', { credentials: 'include' });
        if (res.status === 401) return (location.href = 'login.html');
        const shifts = await res.json();
        const available = shifts.filter(s => s.status !== 'claimed');

        const container = document.getElementById('shiftList');
        container.innerHTML = available.length
        ? available.map(s => `
                <div class="shift">
                    <strong>${s.date} at ${s.time}</strong><br>
                    Location: ${s.location}<br>
                    Notes: ${s.notes || 'None'}<br>
                    Status: ${s.status}<br>
                    <button onclick="claimShift('${s._id}')">Claim</button>
                </div>
            `).join('')
        : '<p>No available shifts at this time.</p>';
    }

        async function loadMyShifts() {
        const res = await fetch('/api/my-shifts', { credentials: 'include' });
        if (res.status === 401) return (location.href = 'login.html');
        const shifts = await res.json();

        const container = document.getElementById('myShiftList');
        container.innerHTML = shifts.length
        ? shifts.map(s => `
                <div class="shift">
                    <strong>${s.date} at ${s.time}</strong><br>
                    Location: ${s.location}<br>
                    Notes: ${s.notes || 'None'}<br>
                    <button onclick="dropShift('${s._id}')">Drop Shift</button>
                </div>
            `).join('')
        : '<p>You have no claimed shifts.</p>';
    }
        async function submitHours(event) {
            event.preventDefault();

            const log = {
                date: document.getElementById('logDate').value,
                startTime: document.getElementById('logStart').value,
                endTime: document.getElementById('logEnd').value,
                location: document.getElementById('logLocation').value,
                position: document.getElementById('logPosition').value,
                hours: document.getElementById('logHours').value
            };

            const res = await fetch('/api/log-hours', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(log)
            });

            const data = await res.json();
            alert(data.message);
            document.getElementById('logHoursForm').reset();
        }

        async function claimShift(id) {
        const res = await fetch('/api/claim', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ shiftId: id })
    });
        const data = await res.json();
        alert(data.message);
        await loadShifts();
        await loadMyShifts();
    }

        async function dropShift(shiftId) {
        const res = await fetch('/api/drop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ shiftId })
    });
        const data = await res.json();
        alert(data.message);
        await loadShifts();
        await loadMyShifts();
    }

        async function logout() {
        try {
        const res = await fetch('/logout', {
        method: 'POST',
        credentials: 'include'
    });
        if (res.ok) {
        window.location.href = 'login.html';
    } else {
        alert('Logout failed.');
    }
    } catch (err) {
        alert('Error logging out: ' + err.message);
    }
    }

        async function switchToOwner() {
        try {
        const res = await fetch('/api/switch-to-owner', {
        method: 'POST',
        credentials: 'include'
    });
        if (res.ok) {
        window.location.href = 'owner-panel.html';
    } else {
        const data = await res.json();
        alert(data.message || 'Only owners can switch to owner view.');
    }
    } catch (err) {
        alert('Error switching view: ' + err.message);
    }
    }

        // ✅ Fixed session check — safely loads shifts after login
        fetch('/api/session-debug', { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
        if (!data.user) return (location.href = 'login.html');
        console.log('Logged in as:', data.user);
        loadShifts();
        loadMyShifts();
    })
        .catch(err => console.error('Session check failed:', err));

</script>

</body>
</html>
